# 如何设计流程
### 设计流程

工作区的拥有者、管理员有权限创建、修改流程的权限。

所谓的流程就是文件的审批过程。在审批王中，每个审批环节我们称为“节点”，节点与节点之间用连线进行串联。一个节点之后可以只有一个节点即只有一种后续的审批情况，也可以通过连线串联多个节点，即有多种的后续审批情况。后续的审批节点即可以由上一步人员在审批时指定也可以根据设置的判断条件系统自动判断。

以创建一个“日常费用报销”流程为例，为您演示如何创建新流程。

具体步骤如下：

（1）   登入华炎云主界面后，点击“设置”，点击“流程设计器”。

（2）   系统会弹出新窗口，在流程列表页中，选择已建立好的表单，如“日常费用报销”。

（3）   在右侧的流程名称中为新流程命名，如将流程命名为“日常费用报销”，命名完毕后，即可开始设计这个流程。一张表单，可以同时对应多个流程。您可以开启一个或多个流程对应您的表单。

（4）   一个审批步骤对应“流程设计器”中的一个节点。将鼠标悬停在某个节点，点击“+”号，即可添加连线。您也可以点击“-”号，将连线删除。

（5）   在属性面板的“画图”中，根据实际需求选择节点，用连线进行节点间的连接。一般而言，“审批”类型的节点，处理人必须选择核准与驳回；而在“填写”类型的节点，处理人可以填写意见或直接提交申请单到下一步处理人，但不能核准或驳回。此外，“会签”节点允许多人同时审批，而“条件”类型节点，系统将会根据设置的条件自动选择下一步。具体可参考“节点类型”。

（6）   通过“属性”对每个节点进行细节设置。如节点名称设置、审批处理人设置、审批超时提醒设置、审批条件判断的设置等。

（7）   选择审批处理人。

  处理人可按不同情形，选择以下：

  审批时指定人员：流转时，由上一步人员选择这一步的处理人员。
  
  指定人员：设置时，指定一个或多个人员作为可选项，由上一步人员流转时选择。
  
  指定审批岗位：流转时，从指定“审批岗位”的对应人员中作出选择。
  
  申请人的上级：固定为“申请人”对应的“直属上级”。
  
  申请人：固定为“申请人”本人。
  
  指定部门：流转时，从指定“部门”的对应人员中作出选择。
  
  指定人员字段：指定字段的值即为处理人。
  
  指定部门字段：流转时，从指定字段的值（即“部门”）的对应人员中作出选择。
  
  指定人员字段相关审批岗位：流转时，从指定字段的值（即“人员”）关联“审批岗位”的对应人员中作出选择。
  
  指定部门字段相关审批岗位：流转时，从指定字段的值（即“部门”）关联“审批岗位”的对应人员中作出选择。
 
  具体可参考“节点的处理人设置”。

（8）  在右侧面板中的“权限”中，可以为各个审批步骤允许编辑的字段打勾。

  “开始”步骤，默认所有字段都可以编辑（已定义了公式的字段除外）；“非开始”步骤，默认所有字段都为只读。可按实际需要设置。

（9）  点击右侧面板中的“画图”，可以添加流程的审批步骤（即节点），命名，并设置相应属性。如本案中，依次添加了总经理审批、财务部审核、报销人提交纸质报销单至财务部、发放报销款、确认收款等节点。

（10）  添加流程连线。然后点击左上角的“保存”按钮、“关闭”按钮。

（11）  启用流程。完成流程的新建。

备注：表单和流程如果已有修改，则修改前已提交的文件，仍然按照修改前的流程走；之后新建、提交的文件，则按照新的步骤流转。

 
### 节点类型

流程设置中，可增加的节点类型有以下四种：

（1）   “审批”类型

仅1人处理（查看申请单、修改申请单、查看附件、增加附件、填写意见等），处理人必须选择核准或驳回。如果选择“驳回”，可驳回到已执行过的任意节点（包括开始节点）。

管理员在设置时，可以指定一个处理人；也可以指定一个相对小的范围，让上一个节点的处理人审批完成后在这个范围内选择一个处理人。具体如何设置，请参考“节点的处理人设置”。

例如，该流程中的“财务审批”、“总经理审批”均属于“审批”类型。

（2）   “填写”类型

仅1人处理（查看申请单、修改申请单、查看附件、增加附件、填写意见等），与“审批”类型不同的是，处理人不能选择核准或驳回、只能发送到下一步骤。

管理员在设置时，可以指定处理人；也可以指定一个相对小的范围，让上一个节点的处理人审批完成后在这个范围内选择一个处理人。具体如何设置，请参考“节点的处理人设置”。

如该流程的“发放报销款”、“报销人确认”就属于“处理”类型，此节点的审批人不需要核准与驳回功能。

（3）   “会签”类型

允许多人同时审批（查看申请单、修改申请单、查看附件、增加附件、填写意见等），处理人必须选择核准或驳回。

管理员在设置时，可以指定一个相对小的范围，让上一个节点的处理人审批完成后在这个范围内选择任意多个处理人（免费版只能最多选择2人）。具体如何设置，请参考“节点的处理人设置”。

注意：“会签”节点后面不允许再紧接着另一个“会签”节点。建议二者之间增加一个类似于“秘书汇总意见”的节点，指定好具体的某个人员，来综合第一个会签节点的意见，再来选择第二个会签节点的处理人员。

如该流程中的“主管领导审批” 就属于“会签”类型，相关部门领导可能都需要会签此申请。

（4）   “条件”类型

系统会自动处理此节点，根据设置的条件选择下一步处理节点。

具体如何设置条件，请参考“节点类型之条件节点”。

注意：“条件”节点后面不允许再紧接着另一个“条件”节点。建议二者合并为一个 “条件”节点。

如该流程中的“条件”，系统将会自动根据申请人报销单金额合计来判断下一步的审批流程。


### 节点类型之条件节点

如何定义条件？

审批王里的条件节点的目标是智能选择审批路径。

如费用报销流程中，报销金额不同，则审批步骤/审批人有所不同。

换言之，需要根据金额来作判断，条件公式为：{采购金额合计}>=10000 和 {采购金额合计}<10000

这里的“金额是否大于10000”就是一个典型的“条件”节点。由系统根据本次申请的实际金额作判断，决定下一步执行“总经理审批”或是“财务经理审批”，执行的判断依据分别是“金额>=10000”和“金额<10000”。

注意：

（1）所有的条件分支不能相互重叠。如上例，假设两个条件分支为“金额>=10000”和“金额<＝10000”，则重叠了金额为10000的情况，如果“金额＝10000”，则系统无法判断走分支1还是分支2。

（2）条件分支应能涵盖所有的情况。如上例，假设两个条件分支为“金额>10000”和“金额<10000”，则遗漏了金额为10000的情况，如果“金额＝10000”，则系统也无法判断走分支1还是分支2。

设置上述条件节点的具体步骤如下：

（1）   添加条件步骤。拖动属性面板画图设置的的“条件”至左侧界面。

（2）   在条件节点的属性区域对条件步骤命名，这里将其命名为“采购金额合计是否大于10000”。

（3）   左侧点击提交节点右上角的“+”，添加两根连线。

（4）   编辑连线一的条件。左侧点击连线一，右侧的属性区域下，设置连线名称与连线条件。这里设置连线条件为“{采购金额合计}>=10000”。具体为什么要这么设置条件，请参考“流程条件的编写规则”。

（5）   编辑另一条连线条件。设置连线条件为“{采购金额合计}<10000”。 具体为什么要这么设置条件，请参考“流程条件的编写规则”。

（6）   编辑完成后，点击上面的“保存”按钮，然后“关闭”按钮。



### 流程条件的编写规则


条件编写有以下基本规则：

- 条件中引用字段需使用字段名+{}，如：{请假天数}；
- 条件中使用的符号必须是半角符号；
- 条件中嵌套条件时，用()；
- 条件中可以使用公式和函数。
 
条件中的判断项目，包括：

- 数值类型常量：直接使用数值，如：1000
- 字符类型常量：使用“"”(注意是半角)将字符串扩起来，如："北京"
- 表单字段变量：使用“{”和“}” (注意都是半角)将字段名扩起来，如：{请假天数}
- 基于申请人的系统变量：包括姓名、角色、部门等
- 申请人的所在部门（全路径）： {applicant.organization.fullname}
- 申请人的所在部门（最底层部门名）： {applicant.organization.name}
- 申请人的角色名： {applicant.roles} 
- 申请人的姓名：{applicant.name} 
- 基于姓名表单字段的系统变量：包括姓名、角色、部门等

  “报销人”的所在部门（全路径）： {报销人}.organization.fullname 

  “报销人”的所在部门（最底层部门名）： {报销人}.organization.name 
  
  “报销人”的角色名： {报销人}.roles
  
  “报销人”的姓名： {报销人}.name
- 基于数值字段的函数：
  加：{字段名1}+{字段名2}

  减：{字段名1}-{字段名2}

  乘：{单价}*{数量}

  除：{总金额}/{数量}
- 基于表格（子表）中的数值字段的函数：
  合计:sum({费用})

  平均值：average({费用})

  计数：count({物品})

  最大值：max({费用})

  最小值：min({费用})
- 统计多选项中有几项被选中了：length({交通工具})
 
- 数值类型的判断，允许使用以下符号：

  = ：等于，如：{借款金额}=1000

  > ：大于，如：{借款金额}>1000

  < ：小于，如：{借款金额}<1000

  >= ：大于等于，如：sum({报销费用合计})>=1000

  <= ：小于等于，如：max({单笔费用金额})<=1000

  != ：不等于，如：sum({借款金额})!=1000

  <> ：不等于，如：sum({借款金额})<>1000

- 字符类型的判断，允许使用以下符号/函数：

  =：是，如：{项目}="北京"
  
  !=：非，如：{项目}!="北京"

  contains()：包含,如：{applicant.roles}.contains('部门经理') 申请人是部门经理。
  
  请注意：由于一个人可能承担了多个审批岗位，所以应该用contains（包含）来判断，而不能用“=”。
 
- 一个条件判断如果不够，可以多个条件判断组合使用。允许组合关系包括：

  ||：或，如：{借款金额}<1000 ||{项目}="北京"

  &&： 与，如：{借款金额}<1000 &&{项目}="北京"

  !:  非，如：!({借款金额}<1000)
 

### 条件判断的实际运用

1）对数值进行判断

如请假天数大于三天需要总经理审批，小于等于三天只需要人事部审核。这类型的判断还用于金额等。

2）对提交人进行判断

如提交人是Tony则由总经理直接审批，若不是则需要部门经理审批。如何取得提交人是谁，则通过公式的编写。

3）对提交人岗位进行判断

如当申请人是部门员工，则由部门经理审批；而当申请人是部门经理，则由总经理审批。条件中，首先要使用系统提供的函数来获取相关的信息。如：{applicant.roles}获取申请人的角色。

4）组合条件进行判断

运用或、与的关系进行多个条件组合判断。如是部门经理或者是办公室人员由办公室审批，而不是部门经理且不是办公室人员的由部门经理审批。

### 节点的处理人设置

流程设置时，节点处理人可选择以下几种：
- 审批时指定人员
  
  设置时，不作其它指定；

  流转时，系统默认为空；由上一步人员选择这一步的处理人员。

- 指定人员
  
  设置时，指定一个或多个人员；

  流转时，系统以指定的一个或多个人员为可选项；由上一步人员选择其中之一（“处理”节点/“审批”节点）或任意多个（“会签节点”）来作为这一步的处理人员。

- 指定审批岗位
  
  设置时，指定一个审批岗位；

  流转时，系统以“申请人”对应这个“审批岗位”的一个或多个人员为可选项；由上一步人员选择其中其中之一（“处理”节点/“审批”节点）或任意多个（“会签节点”）来作为这一步的处理人员。

  关于“审批岗位”的具体设置，参考“设置角色与岗位”。

- 申请人的上级
  
  设置时，不作其它指定；

  流转时，系统找到“申请人”对应的“直属上级”（仅一位）为可选项；因为只有一位，上一步人员无需选择这一步的处理人员。

  人员的“直属上级”在用户管理中设置，参考“设置人员”。

- 申请人
  
  设置时，不作其它指定；

  流转时，系统找到“申请人”本人为可选项；因为只有一位，上一步人员无需选择这一步的处理人员。

- 指定部门
  
  设置时，指定一个或多个部门；

  流转时，系统以这个“部门”所辖的所有人员为可选项；由上一步人员选择其中其中之一（“处理”节点/“审批”节点）或任意多个（“会签节点”）来作为这一步的处理人员。

  关于“部门”所辖人员的具体设置，参考“设置部门”。

- 指定人员字段
  
  设置时，指定表单中的一个字段，这个字段填写的是用户的姓名；

  流转时，系统以申请单上的这个“字段”值（即某用户）为可选项；上一步人员无需选择这一步的处理人员。

- 指定部门字段
  
  设置时，指定表单中的一个字段，这个字段填写的是部门名称；

  流转时，系统以申请单上的这个“字段”的值即某部门所辖的所有人员为可选项；由上一步人员选择其中其中之一（“处理”节点/“审批”节点）或任意多个（“会签节点”）来作为这一步的处理人员。

  关于“部门”所辖人员的具体设置，参考“设置部门”。

- 指定人员字段相关审批岗位
  
  设置时，指定表单中的一个字段（这个字段填写的是用户的姓名）、一个审批岗位；

  流转时，系统以申请单上的这个“字段”值（即某用户）对应这个“审批岗位”的一个或多个人员为可选项；由上一步人员选择其中其中之一（“处理”节点/“审批”节点）或任意多个（“会签节点”）来作为这一步的处理人员。

  关于“审批岗位”的具体设置，参考“设置角色与岗位”。

- 指定部门字段相关审批岗位
  
  设置时，指定表单中的一个字段（这个字段填写的是部门名称）、一个审批岗位；

  流转时，系统以申请单上的这个“字段”值（即某部门）对应这个“审批岗位”的一个或多个人员为可选项;由上一步人员选择其中其中之一（“处理”节点/“审批”节点）或任意多个（“会签节点”）来作为这一步的处理人员。

  关于“审批岗位”的具体设置，参考“设置角色与岗位”。

### 权限设置

##### 谁能新增申请单？

您可以设置新建该申请单的权限。可以选择整个公司均有权限、也可以选择某个部门有权限提交本申请。同时，也可以设置某些个人有权限提交本申请。

设置的方法有两种：

- （一）打开流程设计器，在“开始”节点的“属性”中设置可以新建此表单的人员、部门。

  使用审批王时，只要当前用户在这个部门或人员中，就可以提交这个流程申请单。

- （二）打开流程设计器，点击右侧“流程信息”，点击“设置流程权限”

  系统显示当前的权限设置情况。如需修改，点击“授权部门”、“授权用户”，勾选相应的部门、用户即可。

##### 谁能查看所有的申请单？

有些用户，虽然不一定参与申请单的审批过程，但是需要随时查看某些流程的所有申请单。有时，我们将这样的权限称为“监控权限”。

这个需求，可以通过如下设置来实现。

- 打开流程设计器，点击右侧“流程信息”，点击“设置流程权限”
- 系统显示当前的权限设置情况。如需修改，点击“授权部门”、“授权用户”，勾选相应的部门、用户即可。

##### 谁能删除所有的申请单？

有些用户，虽然不一定参与申请单的审批过程，但是需要随时查看某些流程的所有申请单，并且需要在特定情况下，删除某些申请单。有时，我们将这样的权限称为“管理权限”。

这个需求，可以通过如下设置来实现。

- 打开流程设计器，点击右侧“流程信息”，点击“设置流程权限”
- 系统显示当前的权限设置情况。如需修改，点击“授权部门”、“授权用户”，勾选相应的部门、用户即可。

### 启用、停用、删除流程

流程设计完成后，需要启用才可以让用户提交申请。在流程列表页面中，点击启用状态后的开关，即可启用/停用流程。

点击流程右侧的“X”按钮即可删除流程。点击后系统弹出对话框，请输入流程名，点击“删除”则删除表单，点击“取消”则不删除。

注意：删除流程会同时删除相关的申请单，请谨慎操作，确保不要误删除流程。
